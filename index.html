<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Class Groups & Anonymous Peer Grading — Sheets Backend (No Downloads)</title>
  <style>
    :root{--bg:#0b0f14;--panel:#121822;--muted:#1a2230;--ink:#e8eef7;--ink-dim:#b6c2d4;--accent:#6ea8fe;--ok:#69db7c;--warn:#ffd43b;--err:#ff8787;--shadow:0 10px 25px rgba(0,0,0,.35);}
    html,body{margin:0;height:100%;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;}
    body{background:linear-gradient(180deg,#0b0f14 0%,#0b0f14 45%,#0f141c 100%);color:var(--ink);}    
    .wrap{max-width:1100px;margin:24px auto;padding:20px;}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px}
    .title{font-weight:800;letter-spacing:.2px;font-size:clamp(18px,2.8vw,26px)}
    .subtitle{color:var(--ink-dim);font-size:13px}
    .card{background:var(--panel);border:1px solid #1d2735;border-radius:18px;padding:18px;box-shadow:var(--shadow)}
    .grid{display:grid;gap:14px}
    @media(min-width:900px){.grid.cols-2{grid-template-columns:1.1fr .9fr}}
    h2{font-size:16px;margin:0 0 10px 0}
    label{display:block;margin:10px 0 6px 2px;color:var(--ink-dim);font-size:13px}
    input[type="text"], input[type="number"], textarea, select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #243246;background:#0f1520;color:var(--ink);box-shadow:inset 0 1px 0 rgba(255,255,255,.03);}
    input[type="file"]{width:100%;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid #28354a;background:linear-gradient(180deg,#182132,#131b28);color:var(--ink);cursor:pointer;text-decoration:none;font-weight:600}
    .btn.small{padding:8px 10px;border-radius:10px;font-size:13px}
    .btn.ghost{background:#0f1520}
    .btn.accent{background:linear-gradient(180deg,#2a59b4,#234b96);border-color:#21458b}
    .btn.ok{background:linear-gradient(180deg,#2f7f43,#276b39);border-color:#2a6e3f}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#0f1520;border:1px solid #263044;color:var(--ink-dim);font-size:12px}
    .groups{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:12px}
    .group{background:var(--muted);border:1px solid #273245;border-radius:14px;padding:12px}
    .group h3{margin:.2rem 0 .4rem 0;font-size:14px}
    .group ul{margin:0;padding-left:18px}
    .divider{height:1px;background:linear-gradient(90deg,transparent,#223049,transparent);margin:14px 0}
    .muted{color:var(--ink-dim)}
    .tag{display:inline-flex;align-items:center;gap:6px;background:#0e1524;border:1px solid #243453;padding:6px 8px;border-radius:10px;font-size:12px;color:var(--ink-dim)}
    .footer{opacity:.8;font-size:12px;margin-top:18px}
    .hide{display:none !important}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="title">Class Groups & Anonymous Peer Grading</div>
        <div class="subtitle">Google Sheets backend only. Students never download files or see any grades.</div>
      </div>
      <div id="modeBadge" class="pill">Mode: <span id="modeName">Admin</span></div>
    </header>

    <div id="adminView" class="grid cols-2">
      <section class="card">
        <h2>1) Load students</h2>
        <div class="muted" style="margin-bottom:8px">Upload a CSV with a <span class="mono">name</span> column or paste names (one per line). Duplicates removed automatically.</div>
        <input id="csvFile" type="file" accept=".csv,.txt" />
        <label for="namesText">Or paste names (one per line)</label>
        <textarea id="namesText" rows="6" placeholder="Ada Lovelace\nAlan Turing\n..."></textarea>
        <div class="row">
          <button class="btn" id="btnParse">Load names</button>
          <div class="tag"><span id="countStudents">0</span> students loaded</div>
        </div>
        <div id="dupeWarn" class="muted hide"></div>
        <div class="divider"></div>
        <h2>2) Configure groups & grading</h2>
        <div class="row">
          <div>
            <label for="numGroups">Number of groups (6 or 7)</label>
            <input id="numGroups" type="number" min="2" max="12" step="1" value="6" />
          </div>
          <div>
            <label for="scoreMin">Score min</label>
            <input id="scoreMin" type="number" min="0" max="100" value="2" />
          </div>
          <div>
            <label for="scoreMax">Score max</label>
            <input id="scoreMax" type="number" min="1" max="100" value="7" />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="sessionLabel">Session label (e.g., 2025-08-27)</label>
            <input id="sessionLabel" type="text" placeholder="YYYY-MM-DD" />
          </div>
          <div>
            <label for="keepGraderName">Store grader name in export?</label>
            <select id="keepGraderName">
              <option value="yes" selected>Yes (helps dedup)</option>
              <option value="no">No — instructor sees hash only</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="endpointUrl">Submission endpoint (Apps Script Web App URL)</label>
            <input id="endpointUrl" type="text" placeholder="https://script.google.com/macros/s/AKfycb.../exec" />
          </div>
          <div>
            <label for="endpointSecret">Shared secret (same as in your script)</label>
            <input id="endpointSecret" type="text" placeholder="pF2f3_67-Long-Secret-897asdh" />
          </div>
        </div>
        <div class="row">
          <button id="btnMakeGroups" class="btn accent">Generate random groups</button>
          <button id="btnRandomize" class="btn ghost" disabled>Randomize again</button>
          <button id="btnExportGroups" class="btn ghost" disabled>Export groups CSV</button>
        </div>
      </section>

      <section class="card">
        <h2>3) Share link for student grading</h2>
        <div class="muted">After generating groups, share this link. It encodes groups, scale, and your endpoint + secret so only your Sheet receives data. Students cannot see any grades.</div>
        <label>Student link</label>
        <input id="studentLink" type="text" readonly />
        <div class="row">
          <button id="btnCopyLink" class="btn small">Copy link</button>
          <button id="btnKiosk" class="btn small">Open grading on this device (kiosk)</button>
        </div>
        <div class="divider"></div>
        <h2>4) Groups (preview)</h2>
        <div id="groupsView" class="groups muted">No groups yet.</div>
      </section>
    </div>

    <div id="voteView" class="card hide">
      <h2>Peer grading</h2>
      <div class="muted">Select your group and your name. You'll grade each teammate (not yourself). Your grades are anonymous to peers. Results are sent securely; no files are downloaded.</div>
      <div class="row" style="margin-top:10px">
        <div>
          <label for="selGroup">My group</label>
          <select id="selGroup"></select>
        </div>
        <div>
          <label for="selMe">I am</label>
          <select id="selMe"></select>
        </div>
      </div>
      <div id="gradePanel" class="hide">
        <div class="divider"></div>
        <div class="muted" id="scaleInfo"></div>
        <div id="gradeList" class="grid" style="margin-top:8px"></div>
        <div class="row" style="margin-top:10px">
          <button id="btnSubmitVote" class="btn ok">Submit grades</button>
          <div class="tag" id="voteStatus">Ready</div>
        </div>
      </div>
    </div>

    <div class="footer">Everything runs in-browser</div>
  </div>

  <script>
  const $ = (sel)=>document.querySelector(sel);
  const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
  function shuffle(arr){const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
  function csvEscape(v){if(v==null)return '';const s=String(v);return /[",\n]/.test(s)?'"'+s.replaceAll('"','""')+'"':s;}
  function toCSV(rows){if(!rows.length)return '';const headers=Object.keys(rows[0]);const head=headers.map(csvEscape).join(',');const body=rows.map(r=>headers.map(h=>csvEscape(r[h])).join(',')).join('\n');return head+'\n'+body+'\n';}
  function unique(arr){return [...new Set(arr)];}
  async function readFileAsText(file){return new Promise((resolve,reject)=>{const fr=new FileReader();fr.onload=()=>resolve(fr.result);fr.onerror=()=>reject(fr.error);fr.readAsText(file);});}
  async function shortHash(input){const enc=new TextEncoder();const data=enc.encode(input);const buf=await crypto.subtle.digest('SHA-256',data);const hex=Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');return hex.slice(0,12);}  

  let state={students:[],groups:[],config:{scoreMin:2,scoreMax:7,sessionLabel:'',keepGraderName:'yes',endpointUrl:'',endpointSecret:''},sessionId:'',submissions:[]};
  function updateCounts(){$('#countStudents').textContent=state.students.length;}
  function renderGroups(){const host=$('#groupsView');if(!state.groups.length){host.textContent='No groups yet.';return;}host.innerHTML='';const frag=document.createDocumentFragment();for(const g of state.groups){const card=document.createElement('div');card.className='group';const h=document.createElement('h3');h.textContent=`${g.id} · ${g.members.length} students`;card.appendChild(h);const ul=document.createElement('ul');g.members.forEach(n=>{const li=document.createElement('li');li.textContent=n;ul.appendChild(li);});card.appendChild(ul);frag.appendChild(card);}host.appendChild(frag);}  
  function assignGroups(names,k){const shuffled=shuffle(names);const groups=Array.from({length:k},(_,i)=>({id:`G${i+1}`,members:[]}));let i=0;for(const n of shuffled){groups[i%k].members.push(n);i++;}return groups;}
  function ensureConfig(){const k=Math.max(2,Math.min(12,parseInt($('#numGroups').value||'6',10)));const smin=parseInt($('#scoreMin').value||'1',10);const smax=parseInt($('#scoreMax').value||'10',10);const label=($('#sessionLabel').value||'').trim();const keep=$('#keepGraderName').value||'yes';const endpointUrl=($('#endpointUrl').value||'').trim();const endpointSecret=($('#endpointSecret').value||'').trim();if(smax<=smin){alert('Score max must be greater than min.');throw new Error('bad scale');}state.config={scoreMin:smin,scoreMax:smax,sessionLabel:label,keepGraderName:keep,endpointUrl,endpointSecret};return k;}
  function makeSessionId(){const ts=new Date().toISOString().replace(/[-:.TZ]/g,'');const rand=Math.random().toString(36).slice(2,8);return `${ts}-${rand}`;}
  function encodeSession(){const payload={sessionId:state.sessionId,createdAt:new Date().toISOString(),config:state.config,groups:state.groups};const json=JSON.stringify(payload);return encodeURIComponent(btoa(unescape(encodeURIComponent(json))));}
  function decodeSession(b64){try{const json=decodeURIComponent(escape(atob(decodeURIComponent(b64))));return JSON.parse(json);}catch(e){return null;}}
  function buildStudentLink(){const url=location.origin+location.pathname+`#mode=vote&data=${encodeSession()}`;$('#studentLink').value=url;}

  // Admin handlers
  $('#btnParse').addEventListener('click',async()=>{let names=[];const f=$('#csvFile').files[0];if(f){const txt=await readFileAsText(f);names=parseNamesFromText(txt);}const pasted=parseNamesFromText($('#namesText').value);names=unique([...(names||[]),...(pasted||[])]).filter(Boolean);state.students=names;updateCounts();$('#dupeWarn').classList.toggle('hide',!!names.length);if(!names.length){$('#dupeWarn').textContent='No names found. Upload a CSV with a "name" column or paste names (one per line).';}});
  function parseNamesFromText(t){if(!t)return [];const lines=t.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);if(!lines.length)return [];const first=lines[0].toLowerCase();const names=[];if(first.includes('name')){for(let i=1;i<lines.length;i++){const cols=lines[i].split(',');if(cols[0])names.push(cols[0].trim());}}else{for(const line of lines){const parts=line.split(',');names.push(parts[0].trim());}}return unique(names).filter(Boolean);}  

  $('#btnMakeGroups').addEventListener('click',()=>{if(!state.students.length){alert('Load student names first.');return;}const k=ensureConfig();if(!(k===6||k===7)){if(!confirm('You selected a number of groups other than 6 or 7. Continue?'))return;}if(!state.config.endpointUrl || !state.config.endpointSecret){alert('Please configure your Submission endpoint and Shared secret first.');return;}state.groups=assignGroups(state.students,k);state.sessionId=makeSessionId();renderGroups();updateCounts();$('#btnRandomize').disabled=false;$('#btnExportGroups').disabled=false;buildStudentLink();});
  $('#btnRandomize').addEventListener('click',()=>{if(!state.students.length){alert('Load student names first.');return;}const k=ensureConfig();state.groups=assignGroups(state.students,k);renderGroups();buildStudentLink();});
  $('#btnExportGroups').addEventListener('click',()=>{if(!state.groups.length)return;const rows=[];for(const g of state.groups){for(const m of g.members){rows.push({sessionId:state.sessionId,sessionLabel:state.config.sessionLabel,group:g.id,student:m});}}const csv=toCSV(rows);const blob=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`groups_${state.config.sessionLabel||'session'}_${state.sessionId}.csv`;document.body.appendChild(a);a.click();setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove();},0);});
  $('#btnCopyLink').addEventListener('click',async()=>{const v=$('#studentLink').value;if(!v){alert('Generate groups first.');return;}try{await navigator.clipboard.writeText(v);}catch{}const old=$('#btnCopyLink').textContent;$('#btnCopyLink').textContent='Copied!';setTimeout(()=>$('#btnCopyLink').textContent=old,1200);});
  $('#btnKiosk').addEventListener('click',()=>{const v=$('#studentLink').value;if(!v){alert('Generate groups first.');return;}location.hash=v.split('#')[1];location.reload();});

  // Vote mode
  async function enterVoteMode(payload){
    $('#adminView').classList.add('hide');$('#voteView').classList.remove('hide');$('#modeName').textContent='Student';
    const groups=payload.groups||[];const cfg=payload.config||{scoreMin:1,scoreMax:10};
    const selGroup=$('#selGroup');selGroup.innerHTML='';groups.forEach(g=>{const o=document.createElement('option');o.value=g.id;o.textContent=`${g.id} (${g.members.length})`;selGroup.appendChild(o);});
    function populateNames(){const g=groups.find(x=>x.id===selGroup.value);const me=$('#selMe');me.innerHTML='';(g?.members||[]).forEach(n=>{const o=document.createElement('option');o.value=n;o.textContent=n;me.appendChild(o);});buildGradeForm();}
    selGroup.addEventListener('change',populateNames);$('#selMe').addEventListener('change',buildGradeForm);populateNames();
    function buildGradeForm(){const groupId=$('#selGroup').value;const me=$('#selMe').value;const g=groups.find(x=>x.id===groupId);const others=(g?.members||[]).filter(n=>n!==me);$('#gradePanel').classList.remove('hide');$('#scaleInfo').textContent=`Use scale ${cfg.scoreMin}–${cfg.scoreMax}.`;const host=$('#gradeList');host.innerHTML='';for(const name of others){const row=document.createElement('div');row.className='row';const label=document.createElement('div');label.textContent=name;label.style.minWidth='220px';const input=document.createElement('input');input.type='number';input.min=cfg.scoreMin;input.max=cfg.scoreMax;input.step='1';input.placeholder=cfg.scoreMin;input.dataset.name=name;input.required=true;row.appendChild(label);row.appendChild(input);host.appendChild(row);} }
    
    $('#btnSubmitVote').addEventListener('click',async()=>{
      const groupId=$('#selGroup').value;const me=$('#selMe').value;const cfg=payload.config||{};
      if(!groupId||!me){alert('Pick your group and your name.');return;}
      const inputs=Array.from($('#gradeList').querySelectorAll('input[type="number"]'));
      if(!inputs.length){alert('No teammates to grade.');return;}
      const scores=[];const min=(cfg.scoreMin??1),max=(cfg.scoreMax??10);
      for(const inp of inputs){const v=parseInt(inp.value||'',10);if(Number.isNaN(v)||v<min||v>max){alert(`Please enter a number ${min}–${max} for ${inp.dataset.name}.`);return;}scores.push({name:inp.dataset.name,grade:v});}
      $('#voteStatus').textContent='Submitting…';
      const graderHash=await shortHash(payload.sessionId+'|'+me);
      const keepName=(payload.config?.keepGraderName||'yes')==='yes';
      const endpoint=(payload.config?.endpointUrl||'').trim();
      const secret=(payload.config?.endpointSecret||'').trim();
      if(!endpoint||!secret){$('#voteStatus').textContent='⚠️ This session is misconfigured. Please tell your instructor.';return;}
      const records=scores.map(s=>({sessionId:payload.sessionId,sessionLabel:payload.config?.sessionLabel||'',groupId,grader:keepName?me:'',graderHash,recipient:s.name,grade:s.grade,submittedAt:new Date().toISOString()}));

      try{
        // Use text/plain to keep the request "simple" (no preflight)
        const resp=await fetch(endpoint,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({
          secret,
          sessionId:payload.sessionId,
          sessionLabel:payload.config?.sessionLabel||'',
          groupId,
          grader:keepName?me:'',
          graderHash,
          records
        })});
        // Try to read JSON; if not, assume success if no exception
        let okFlag=true;
        try{
          const data=await resp.json();
          okFlag = !!data.ok;
        }catch(e){/* ignore parse issues */}
        if(!okFlag) throw new Error('Server returned error');
        $('#voteStatus').textContent='✅ Submitted securely. You may close this tab.';
        $$('#gradeList input').forEach(i=>i.value='');
        return;
      }catch(e){
        console.warn('POST failed',e);
        $('#voteStatus').textContent='⚠️ Network issue — submission failed. Please try again later.';
        return;
      }
    });
  }

  function setModeBadge(){const mode=new URLSearchParams(location.hash.replace('#','')).get('mode');$('#modeName').textContent=(mode==='vote')?'Student':'Admin';}
  setModeBadge();
  (async function init(){const hash=new URLSearchParams(location.hash.replace('#',''));if(hash.get('mode')==='vote'){const data=hash.get('data');const payload=decodeSession(data||'');if(!payload){alert('Invalid or missing session data in link. Ask your instructor for a fresh link.');return;}await enterVoteMode(payload);return;}$('#adminView').classList.remove('hide');})();
  </script>
</body>
</html>
